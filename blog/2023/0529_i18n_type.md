---
title: 编写 vite 插件自动生成 i18n 类型提示  
category: practice  
---  

## 编写 vite 插件自动生成 i18n 类型提示  

### 最终效果  
`编写时候的参数智能提示`：  

![An image](../../images/2023/WX20230530-153719@2x.png)

`鼠标移动上去看到中文注释`:  

![An image](../../images/2023/WeChat64884b6ce371e5cf65e2dcc40b3504b6.png)


### 思路  

编写 vite 插件自动监听 i18n 配置文件变化，自动生成类型声明文件  

### 实现  

```javascript
import fs from 'node:fs'
import path from 'node:path'
const targetDir = './src/i18n'
const regExp = /const\s*cn\s*=\s*\{[^}]*\}/gm
export default function definePlugin() {
  return {
    name: 'i18nTypeGen',
    apply: 'serve', // 默认情况下插件在开发（serve）和构建（build）模式中都会调用 这里指定开发环境
    handleHotUpdate({ file,read }) {
      if(file.includes('src/i18n')){
        console.log('i18n file changed')
        read().then(res=>{
          const files = fs.readdirSync(targetDir);
          let resObj = {}
          files.forEach(file=>{
            const filePath = path.join(targetDir, file);
            const content = fs.readFileSync(filePath, 'utf-8');
            const matchResult = content.match(regExp)
            if(matchResult){
              const res = new Function(matchResult[0]+'\n'+'return cn')()
              const keys = Object.keys(res)
              if(keys.length){
                Object.assign(
                  resObj,
                  Object.keys(res).reduce((a,b)=>{
                    a[`${file.replace(/\.[^.]+/,'')}.${b}`] = res[b]
                    return a
                  },{})
                )
              }
            }
          })
          insert(resObj)
        })
      }
    }
  }
}


const insert = (resObj)=>{
  fs.writeFileSync('./i18nTips.d.ts', 
    `
/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
// 自动生成i18n的$t类型 助力写入参的提示
import '@vue/runtime-core'

export {}

declare module '@vue/runtime-core' {
export interface ComponentCustomProperties{
  $t<T extends keyof I18nTempType>(key:T):I18nTempType[T]
}
}

export type I18nTempType = ${JSON.stringify(resObj)}
    `
  );
}

```

### 缺陷  

出于性能考虑，使用了正则匹配配置文件的具体代码，所以配置文件需要按照约定编写  